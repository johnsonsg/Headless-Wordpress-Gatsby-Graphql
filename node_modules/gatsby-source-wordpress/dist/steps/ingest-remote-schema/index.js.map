{"version":3,"sources":["../../../src/steps/ingest-remote-schema/index.js"],"names":["ingestRemoteSchema","helpers","pluginOptions","schemaTimeKey","lastIngestRemoteSchemaTime","cache","get","ingestedSchemaInLastTenSeconds","Date","now","set","activity","reporter","activityTimer","start","checkIfSchemaHasChanged","introspectAndStoreRemoteSchema","identifyAndStoreIngestableFieldsAndTypes","buildNodeQueries","buildNonNodeQueries","cacheFetchedTypes","writeQueriesToDisk","e","panic","end"],"mappings":";;;;;AAAA;;AACA;;AAEA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AAEA,MAAMA,kBAAkB,GAAG,OAAOC,OAAP,EAAgBC,aAAhB,KAAkC;AAC3D,QAAMC,aAAa,GAAI,4BAAvB;AACA,QAAMC,0BAA0B,GAAG,MAAMH,OAAO,CAACI,KAAR,CAAcC,GAAd,CAAkBH,aAAlB,CAAzC;AAEA,QAAMI,8BAA8B,GAClCC,IAAI,CAACC,GAAL,KAAaL,0BAAb,IAA2C,KAD7C;;AAGA,MAAIA,0BAA0B,IAAIG,8BAAlC,EAAkE;AAChE;AACA;AACA;AACD;;AAED,QAAMN,OAAO,CAACI,KAAR,CAAcK,GAAd,CAAkBP,aAAlB,EAAiCK,IAAI,CAACC,GAAL,EAAjC,CAAN;AAEA,QAAME,QAAQ,GAAGV,OAAO,CAACW,QAAR,CAAiBC,aAAjB,CACf,wCAAkB,yBAAlB,CADe,CAAjB;AAIAF,EAAAA,QAAQ,CAACG,KAAT;;AAEA,MAAI;AACF,UAAM,wBACJ,CACEC,oCADF,EAEEC,sDAFF,EAGEC,yEAHF,EAIE,CAACC,kCAAD,EAAmBC,mEAAnB,CAJF,EAKE,CAACC,oCAAD,EAAoBC,sCAApB,CALF,CADI,EAQJpB,OARI,EASJC,aATI,CAAN;AAWD,GAZD,CAYE,OAAOoB,CAAP,EAAU;AACVrB,IAAAA,OAAO,CAACW,QAAR,CAAiBW,KAAjB,CAAuBD,CAAvB;AACD;;AAEDX,EAAAA,QAAQ,CAACa,GAAT;AACD,CAtCD","sourcesContent":["import { runSteps } from \"~/utils/run-steps\"\nimport { formatLogMessage } from \"~/utils/format-log-message\"\n\nimport { checkIfSchemaHasChanged } from \"./diff-schemas\"\nimport { introspectAndStoreRemoteSchema } from \"./introspect-remote-schema\"\nimport { identifyAndStoreIngestableFieldsAndTypes } from \"./identify-and-store-ingestable-types\"\nimport { buildNonNodeQueries } from \"./build-and-store-ingestible-root-field-non-node-queries\"\nimport { buildNodeQueries } from \"./build-queries-from-introspection/build-node-queries\"\nimport { cacheFetchedTypes } from \"./cache-fetched-types\"\nimport { writeQueriesToDisk } from \"./write-queries-to-disk\"\n\nconst ingestRemoteSchema = async (helpers, pluginOptions) => {\n  const schemaTimeKey = `lastIngestRemoteSchemaTime`\n  const lastIngestRemoteSchemaTime = await helpers.cache.get(schemaTimeKey)\n\n  const ingestedSchemaInLastTenSeconds =\n    Date.now() - lastIngestRemoteSchemaTime <= 10000\n\n  if (lastIngestRemoteSchemaTime && ingestedSchemaInLastTenSeconds) {\n    // only allow this to run once every ten seconds\n    // this prevents thrashing when many webhooks are received at once\n    return\n  }\n\n  await helpers.cache.set(schemaTimeKey, Date.now())\n\n  const activity = helpers.reporter.activityTimer(\n    formatLogMessage(`ingest WPGraphQL schema`)\n  )\n\n  activity.start()\n\n  try {\n    await runSteps(\n      [\n        checkIfSchemaHasChanged,\n        introspectAndStoreRemoteSchema,\n        identifyAndStoreIngestableFieldsAndTypes,\n        [buildNodeQueries, buildNonNodeQueries],\n        [cacheFetchedTypes, writeQueriesToDisk],\n      ],\n      helpers,\n      pluginOptions\n    )\n  } catch (e) {\n    helpers.reporter.panic(e)\n  }\n\n  activity.end()\n}\n\nexport { ingestRemoteSchema }\n"],"file":"index.js"}