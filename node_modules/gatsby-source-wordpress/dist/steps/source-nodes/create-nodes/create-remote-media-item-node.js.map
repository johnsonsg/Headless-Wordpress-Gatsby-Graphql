{"version":3,"sources":["../../../../src/steps/source-nodes/create-nodes/create-remote-media-item-node.js"],"names":["getFileNodeMetaBySourceUrl","sourceUrl","fileNodesMetaByUrls","store","getState","imageNodes","nodeMetaByUrl","getMediaItemEditLink","node","helpers","pluginOptions","gatsbyApi","protocol","hostname","url","parse","link","baseUrl","databaseId","parentNode","parentHtmlNode","getNode","id","errorPanicker","error","reporter","fetchState","parentName","editUrl","stepMessage","mediaItemLink","editLink","fileUrl","mediaItemUrl","sharedError","errorString","toString","allow404ImagesInProduction","production","allow404Images","process","env","NODE_ENV","includes","shouldBail","log","warn","info","panic","join","getFileNodeByMediaItemNode","mediaItemNode","modifiedGmt","existingNodeMeta","internal","type","localFile","failedImageUrls","Set","createRemoteMediaItemNode","skipExistingNode","state","existingNode","gatsbyStore","cache","createNodeId","actions","createNode","mimeType","title","fileSize","has","wpUrl","remoteSchema","src","excludeByMimeTypes","maxFileSizeBytes","MediaItem","hardCachedFileRelativePath","hardCachedMediaFilesDirectory","cwd","hardCachedFilePath","hardCacheMediaFiles","develop","remoteFileNode","add","createFileNodeRequirements","parentNodeId","buffer","fs","readFile","name","ext","path","extname","e","wpUrlHostname","mediaItemHostname","htaccessCredentials","auth","htaccess","shouldUseHtaccessCredentials","htaccess_pass","password","htaccess_user","username","retries","factor","minTimeout","onRetry","dispatch","pushNodeMeta","ensureDir","dirname","copyFile","absolutePath"],"mappings":"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","sourcesContent":["import fs from \"fs-extra\"\nimport path from \"path\"\nimport url from \"url\"\nimport { bold } from \"chalk\"\n\nimport retry from \"async-retry\"\n\nimport { createFileNodeFromBuffer } from \"gatsby-source-filesystem\"\n\nimport createRemoteFileNode from \"./create-remote-file-node/index\"\n\nimport store from \"~/store\"\n\nimport urlToPath from \"~/utils/url-to-path\"\nimport { formatLogMessage } from \"~/utils/format-log-message\"\nimport { stripImageSizesFromUrl } from \"~/steps/source-nodes/fetch-nodes/fetch-referenced-media-items\"\nimport { ensureSrcHasHostname } from \"./process-node\"\n\nexport const getFileNodeMetaBySourceUrl = sourceUrl => {\n  const fileNodesMetaByUrls = store.getState().imageNodes.nodeMetaByUrl\n\n  return fileNodesMetaByUrls[stripImageSizesFromUrl(sourceUrl)]\n}\n\nexport const getMediaItemEditLink = node => {\n  const { helpers, pluginOptions } = store.getState().gatsbyApi\n\n  const { protocol, hostname } = url.parse(node?.link || pluginOptions.url)\n  const baseUrl = `${protocol}//${hostname}`\n\n  const databaseId = node.databaseId\n\n  if (!databaseId) {\n    const parentNode = node.parentHtmlNode || helpers.getNode(node.id)\n\n    if (!parentNode?.databaseId) {\n      return null\n    }\n\n    return `${baseUrl}/wp-admin/post.php?post=${parentNode.databaseId}&action=edit`\n  }\n\n  return `${baseUrl}/wp-admin/upload.php?item=${node.databaseId}`\n}\n\nexport const errorPanicker = ({\n  error,\n  reporter,\n  node,\n  fetchState,\n  parentName,\n}) => {\n  const editUrl = getMediaItemEditLink(node)\n\n  const stepMessage = parentName ? ` in step:\\n\\n\"${parentName}\"` : ``\n  const mediaItemLink = node.link ? `\\nMedia item link: ${node.link}` : ``\n  const editLink = `\\nEdit link: ${editUrl || `N/A`}`\n  const fileUrl = `\\nFile url: ${node.mediaItemUrl}`\n\n  const sharedError = `occurred while fetching media item${\n    node.databaseId ? ` #${node.databaseId}` : ``\n  }${stepMessage}\\n${mediaItemLink}${editLink}${fileUrl}`\n\n  const errorString =\n    typeof error === `string` ? error : error && error.toString()\n\n  const { pluginOptions } = store.getState().gatsbyApi\n  const allow404ImagesInProduction = pluginOptions.production.allow404Images\n\n  if (\n    (allow404ImagesInProduction || process.env.NODE_ENV !== `production`) &&\n    errorString.includes(`Response code 404`)\n  ) {\n    fetchState.shouldBail = true\n\n    reporter.log(``)\n    reporter.warn(\n      formatLogMessage(\n        `Error ${sharedError}${\n          !allow404ImagesInProduction\n            ? `\\n\\nThis error will fail production builds.`\n            : ``\n        }`\n      )\n    )\n    reporter.log(``)\n\n    return\n  }\n\n  if (errorString.includes(`Response code 4`)) {\n    reporter.log(``)\n    reporter.info(\n      formatLogMessage(\n        `Unrecoverable error ${sharedError}\\n\\nFailing the build to prevent deploying a broken site.${\n          errorString.includes(`Response code 404`)\n            ? `\\n\\nIf you don't want 404's to fail your production builds, you can set the following option:\n\n{\n  options: {\n    production: {\n      allow404Images: true\n    }\n  }\n}`\n            : ``\n        }`\n      )\n    )\n    reporter.panic(error)\n  } else if (errorString.includes(`Response code 5`)) {\n    reporter.log(``)\n    reporter.info(\n      formatLogMessage(\n        [\n          `Unrecoverable error ${sharedError}`,\n          `\\nYour wordpress host appears to be overloaded by our requests for images`,\n          `\\nIn ${bold(`gatsby-config.js`)}, try lowering the ${bold(\n            `requestConcurrency`\n          )} for MediaItems:`,\n          `\\nplugins: [\n  {\n    resolve: 'gatsby-source-wordpress',\n    options: {\n      url: 'https://mysite.com/graphql',\n      type: {\n        MediaItem: {\n          localFile: {\n            requestConcurrency: 50\n          }\n        }\n      }\n    },\n  }\n]`,\n          `\\nnote that GATSBY_CONCURRENT_REQUEST environment variable has been retired for these options`,\n        ].join(`\\n`)\n      )\n    )\n    reporter.panic(error)\n  }\n}\n\nexport const getFileNodeByMediaItemNode = async ({\n  mediaItemNode,\n  helpers,\n}) => {\n  const { sourceUrl, modifiedGmt, mediaItemUrl, databaseId } = mediaItemNode\n\n  const fileUrl = sourceUrl || mediaItemUrl\n\n  if (!fileUrl) {\n    helpers.reporter.warn(\n      formatLogMessage(`Couldn't find source url for media item #${databaseId}`)\n    )\n    return null\n  }\n\n  const existingNodeMeta = getFileNodeMetaBySourceUrl(fileUrl)\n\n  if (\n    // if we already have this image\n    existingNodeMeta &&\n    existingNodeMeta.id &&\n    // and it hasn't been modified\n    existingNodeMeta.modifiedGmt === modifiedGmt\n  ) {\n    let node = await helpers.getNode(existingNodeMeta.id)\n\n    // some of the cached node metas dont necessarily need to be a File\n    // so make sure we return a File node if what we get isn't one\n    if (node && node.internal && node.internal.type !== `File`) {\n      if (node.localFile && node.localFile.id) {\n        // look up the corresponding file node\n        node = await helpers.getNode(node.localFile.id)\n      } else {\n        return null\n      }\n    }\n\n    return node\n  }\n\n  return null\n}\n\nconst failedImageUrls = new Set()\n\nexport const createRemoteMediaItemNode = async ({\n  mediaItemNode,\n  parentName,\n  skipExistingNode = false,\n}) => {\n  const state = store.getState()\n  const { helpers, pluginOptions } = state.gatsbyApi\n\n  const existingNode = !skipExistingNode\n    ? await getFileNodeByMediaItemNode({\n        mediaItemNode,\n        helpers,\n      })\n    : null\n\n  if (existingNode) {\n    return existingNode\n  }\n\n  const {\n    store: gatsbyStore,\n    cache,\n    createNodeId,\n    reporter,\n    actions: { createNode },\n  } = helpers\n\n  let { mediaItemUrl, modifiedGmt, mimeType, title, fileSize } = mediaItemNode\n\n  if (!mediaItemUrl || failedImageUrls.has(mediaItemUrl)) {\n    return null\n  }\n\n  const { wpUrl } = state.remoteSchema\n  mediaItemUrl = ensureSrcHasHostname({ wpUrl, src: mediaItemUrl })\n\n  const {\n    excludeByMimeTypes,\n    maxFileSizeBytes,\n  } = pluginOptions.type?.MediaItem?.localFile\n\n  // if this file is larger than maxFileSizeBytes, don't fetch the remote file\n  if (fileSize > maxFileSizeBytes) {\n    return null\n  }\n\n  // if this type of file is excluded, don't fetch the remote file\n  if (excludeByMimeTypes.includes(mimeType)) {\n    return null\n  }\n\n  const hardCachedFileRelativePath = urlToPath(mediaItemUrl)\n  const hardCachedMediaFilesDirectory = `${process.cwd()}/.wordpress-cache`\n\n  const hardCachedFilePath =\n    hardCachedMediaFilesDirectory + hardCachedFileRelativePath\n\n  const hardCacheMediaFiles =\n    (process.env.NODE_ENV === `development` &&\n      pluginOptions.develop.hardCacheMediaFiles) ||\n    (process.env.NODE_ENV === `production` &&\n      pluginOptions.production.hardCacheMediaFiles)\n\n  const fetchState = {\n    shouldBail: false,\n  }\n  // Otherwise we need to download it\n  const remoteFileNode = await retry(\n    async () => {\n      if (fetchState.shouldBail) {\n        failedImageUrls.add(mediaItemUrl)\n        return null\n      }\n\n      const createFileNodeRequirements = {\n        parentNodeId: mediaItemNode.id,\n        store: gatsbyStore,\n        cache,\n        createNode,\n        createNodeId,\n        reporter,\n      }\n\n      if (hardCacheMediaFiles) {\n        // check for file in .wordpress-cache/wp-content\n        // if it exists, use that to create a node from instead of\n        // fetching from wp\n        try {\n          const buffer = await fs.readFile(hardCachedFilePath)\n          const node = await createFileNodeFromBuffer({\n            buffer,\n            name: title,\n            ext: path.extname(mediaItemUrl),\n            ...createFileNodeRequirements,\n          })\n\n          if (node) {\n            return node\n          }\n        } catch (e) {\n          // ignore errors, we'll download the image below if it doesn't exist\n        }\n      }\n\n      const { hostname: wpUrlHostname } = url.parse(wpUrl)\n      const { hostname: mediaItemHostname } = url.parse(mediaItemUrl)\n\n      const htaccessCredentials = pluginOptions.auth.htaccess\n\n      // if media items are hosted on another url like s3,\n      // using the htaccess creds will throw 400 errors\n      const shouldUseHtaccessCredentials = wpUrlHostname === mediaItemHostname\n\n      const auth =\n        htaccessCredentials && shouldUseHtaccessCredentials\n          ? {\n              htaccess_pass: htaccessCredentials?.password,\n              htaccess_user: htaccessCredentials?.username,\n            }\n          : null\n\n      // if this errors, it's caught one level above in fetch-referenced-media-items.js so it can be placed on the end of the request queue\n      const node = await createRemoteFileNode({\n        url: mediaItemUrl,\n        auth,\n        ...createFileNodeRequirements,\n      })\n\n      return node\n    },\n    {\n      retries: 3,\n      factor: 1.1,\n      minTimeout: 5000,\n      onRetry: error =>\n        errorPanicker({\n          error,\n          reporter,\n          node: mediaItemNode,\n          fetchState,\n          parentName,\n        }),\n    }\n  )\n\n  if (!remoteFileNode) {\n    return null\n  }\n\n  // push it's id and url to our store for caching,\n  // so we can touch this node next time\n  // and so we can easily access the id by source url later\n  store.dispatch.imageNodes.pushNodeMeta({\n    id: remoteFileNode.id,\n    sourceUrl: mediaItemUrl,\n    modifiedGmt,\n  })\n\n  if (hardCacheMediaFiles) {\n    try {\n      // make sure the directory exists\n      await fs.ensureDir(path.dirname(hardCachedFilePath))\n      // copy our downloaded file to our existing directory\n      await fs.copyFile(remoteFileNode.absolutePath, hardCachedFilePath)\n    } catch (e) {\n      helpers.reporter.panic(e)\n    }\n  }\n\n  // and use it\n  return remoteFileNode\n}\n"],"file":"create-remote-media-item-node.js"}